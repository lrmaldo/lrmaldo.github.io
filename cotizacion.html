<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizaci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            border-bottom: 3px solid #2c5f2d;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        
        .logo-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .company-info h1 {
            color: #2c5f2d;
            font-size: 22px;
            margin-bottom: 2px;
        }
        
        .company-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }
        
        .quote-title {
            text-align: right;
            font-size: 20px;
            color: #2c5f2d;
            font-weight: bold;
        }
        
        .quote-number {
            text-align: right;
            color: #999;
            font-size: 11px;
            margin-top: 3px;
        }
        
        .client-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 5px;
            page-break-inside: avoid;
        }
        
        .client-info div {
            font-size: 12px;
        }
        
        .client-info label {
            font-weight: bold;
            color: #2c5f2d;
            display: block;
            margin-bottom: 2px;
            font-size: 12px;
        }
        
        .client-info p {
            color: #333;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0 12px 0;
            page-break-inside: avoid;
        }
        
        th {
            background-color: #2c5f2d;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #2c5f2d;
            font-size: 11px;
        }
        
        td {
            padding: 6px 8px;
            border: 1px solid #ddd;
            color: #333;
            font-size: 11px;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .description {
            font-size: 10px;
            line-height: 1.2;
        }
        
        .quantity {
            text-align: center;
            font-weight: bold;
        }
        
        .unit-price {
            text-align: right;
            font-weight: bold;
        }
        
        .total {
            text-align: right;
            font-weight: bold;
            color: #2c5f2d;
        }
        
        .summary {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
            page-break-inside: avoid;
        }
        
        .summary-box {
            width: 350px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
        }
        
        .summary-row.total-row {
            background-color: #2c5f2d;
            color: white;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #2c5f2d;
            padding: 10px;
        }
        
        .terms {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f5f1;
            border-left: 4px solid #2c5f2d;
            font-size: 12px;
            color: #555;
            page-break-inside: avoid;
        }
        
        .terms h3 {
            color: #2c5f2d;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .terms ul {
            margin-left: 20px;
            line-height: 1.5;
        }
        
        .terms li {
            margin-bottom: 5px;
            font-size: 11px;
        }
        
        .footer {
            margin-top: 15px;
            text-align: center;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            color: #999;
            font-size: 10px;
        }
        
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            page-break-inside: avoid;
        }
        
        .signature {
            text-align: center;
            width: 40%;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 30px;
            margin-bottom: 3px;
            height: 1px;
        }
        
        .signature-name {
            font-size: 11px;
            font-weight: bold;
            color: #333;
        }
        
        .validity {
            text-align: center;
            margin-top: 12px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 11px;
            color: #856404;
            page-break-inside: avoid;
        }
        
        .print-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: #2c5f2d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        
        .print-btn:hover {
            background-color: #1f4620;
        }

        .editor-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 8px;
        }

        .editor-toolbar .mini {
            font-size: 11px;
            color: #666;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 999px;
            background-color: #fff;
            font-size: 11px;
            color: #333;
        }

        .chip input[type="checkbox"] {
            transform: translateY(1px);
        }

        .btn-small {
            padding: 8px 12px;
            background-color: #2c5f2d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-small.secondary {
            background-color: #666;
        }

        .btn-small.danger {
            background-color: #8b2a2a;
        }

        .btn-small:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .add-service {
            display: grid;
            grid-template-columns: 1.5fr 2fr 0.7fr 0.7fr auto;
            gap: 8px;
            align-items: end;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin: 10px 0;
            page-break-inside: avoid;
        }

        .field label {
            font-weight: bold;
            color: #2c5f2d;
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .field input,
        .field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
        }

        .field textarea {
            resize: vertical;
            min-height: 36px;
            max-height: 90px;
        }

        .table-input {
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            font: inherit;
            color: inherit;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .table-input:focus {
            outline: none;
            border-color: #2c5f2d;
            background: #fff;
        }

        .desc-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .delete-link {
            background: transparent;
            border: none;
            color: #8b2a2a;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }

        .muted {
            color: #999;
        }
        
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 0;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
                margin: 0;
                padding: 10mm 12mm;
            }
            .print-btn {
                display: none;
            }
            .no-print {
                display: none !important;
            }
            .table-input {
                border-color: transparent !important;
                padding: 0 !important;
            }
            .add-service {
                display: none !important;
            }
            table {
                page-break-inside: avoid;
                margin: 5px 0 8px 0;
            }
            .summary {
                page-break-inside: avoid;
            }
            .client-info {
                page-break-inside: avoid;
            }
            h3 {
                margin: 5px 0 8px 0;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
    
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div class="company-info">
                    <h1>üêÑ SOLUCIONES GANADERAS</h1>
                    <p>Desarrollo de Software Especializado</p>
                </div>
                <div>
                    <div class="quote-title">COTIZACI√ìN</div>
                    <div class="quote-number">Fecha: <span id="quoteDateText">09 de Diciembre, 2025</span></div>
                </div>
            </div>
        </div>

        <div class="editor-toolbar no-print">
            <div class="chip">
                <input id="applyIva" type="checkbox" />
                <label for="applyIva">Requiere factura fiscal (aplicar IVA 16%)</label>
            </div>
            <button id="resetBtn" class="btn-small secondary" type="button">Restablecer</button>
            <span id="saveStatus" class="mini muted">Listo</span>
        </div>
        
        <div class="client-info">
            <div>
                <label>CLIENTE:</label>
                <p>Faustino Florentino</p>
                <label>UBICACI√ìN:</label>
                <p>Veracruz, M√©xico</p>
            </div>
            <div>
                <label>PROYECTO:</label>
                <p>Sistema de Registro de Ganado</p>
                <label>VALIDEZ:</label>
                <p>30 d√≠as a partir de esta fecha</p>
            </div>
        </div>
        
        <h3 style="color: #2c5f2d; margin-bottom: 15px; font-size: 16px;">DESGLOSE DE SERVICIOS</h3>

        <form id="addServiceForm" class="add-service no-print" autocomplete="off">
            <div class="field">
                <label for="newTitle">Servicio</label>
                <input id="newTitle" type="text" placeholder="Ej. Desarrollo Backend" required />
            </div>
            <div class="field">
                <label for="newDesc">Descripci√≥n</label>
                <textarea id="newDesc" placeholder="Detalles del servicio" required></textarea>
            </div>
            <div class="field">
                <label for="newHours">Horas</label>
                <input id="newHours" type="number" min="0" step="0.5" value="1" required />
            </div>
            <div class="field">
                <label for="newRate">Tarifa/Hora</label>
                <input id="newRate" type="number" min="0" step="1" value="150" required />
            </div>
            <button class="btn-small" type="submit">Agregar</button>
        </form>
        
        <table>
            <thead>
                <tr>
                    <th style="width: 50%;">Descripci√≥n del Servicio</th>
                    <th style="width: 15%;">Horas</th>
                    <th style="width: 15%;">Tarifa/Hora</th>
                    <th style="width: 20%;">Total</th>
                </tr>
            </thead>
            <tbody id="servicesBody"></tbody>
            <tbody>
                <tr style="background-color: #f0f5f1; font-weight: bold;">
                    <td colspan="3" style="text-align: right;">TOTAL DE HORAS: <span id="totalHours">0</span></td>
                    <td class="total"><span id="tableSubtotal">$0</span></td>
                </tr>
            </tbody>
        </table>
        
        <div class="summary">
            <div class="summary-box">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="summarySubtotal">$0</span>
                </div>
                <div id="ivaRow" class="summary-row">
                    <span>IVA (16%):</span>
                    <span id="summaryIva">$0</span>
                </div>
                <div class="summary-row total-row">
                    <span>TOTAL:</span>
                    <span id="summaryTotal">$0</span>
                </div>
            </div>
        </div>
        
        <div class="terms">
            <h3>üìã T√âRMINOS Y CONDICIONES</h3>
            <ul>
                <li><strong>Alcance:</strong> Desarrollo del sistema de acuerdo a especificaciones proporcionadas. No incluye hosting ni infraestructura de servidores.</li>
                <li><strong>Metodolog√≠a:</strong> Entregas parciales cada 15 d√≠as para revisi√≥n y feedback.</li>
                <li><strong>Revisiones:</strong> Se incluyen 2 rondas de revisiones y ajustes. Cambios adicionales se cotizar√°n por separado.</li>
                <li><strong>Plazo de Entrega:</strong> Aproximadamente 4-5 semanas desde la firma del contrato.</li>
                <li><strong>Pago:</strong> 50% al inicio del proyecto, 50% a la entrega final.</li>
                <li><strong>Soporte:</strong> Se ofrece soporte t√©cnico por 30 d√≠as posteriores a la entrega (sin costo adicional).</li>
                <li><strong>Tecnolog√≠a:</strong> Laravel 12, PHP 8.2+, MySQL, Livewire, Tailwindcss.</li>
                   <!-- si no requiere factura fiscal el costo seria el subtotal -->
                   <li><strong>Factura:</strong> Si el cliente NO requiere factura fiscal, el importe a pagar ser√° el <strong>subtotal (sin IVA)</strong>. Si solicita factura fiscal, se aplicar√° el IVA correspondiente y la cotizaci√≥n se ajustar√° para incluirlo ‚Äî por favor solicitar factura al aceptar la cotizaci√≥n.</li>
            </ul>
        </div>
        
        <div class="validity">
            <strong>‚è∞ Esta cotizaci√≥n es v√°lida por 30 d√≠as a partir de la fecha indicada.</strong><br>
            
        </div>
        
        <div class="signature-section">
            <div class="signature">
                <p style="margin-bottom: 50px; font-size: 13px;"><strong>Preparado por:</strong></p>
                <div class="signature-line"></div>
                <div class="signature-name">Ing. Leonardo Maldonado</div>
            </div>
            <div class="signature">
                <p style="margin-bottom: 50px; font-size: 13px;"><strong>Aceptado por:</strong></p>
                <div class="signature-line"></div>
                <div class="signature-name">Faustino Florentino</div>
            </div>
        </div>
        
        <div class="footer">
            <p>Cotizaci√≥n preparada: 09 de Diciembre, 2025 | Sistema de Registro de Ganado v1.0</p>
        </div>
    </div>

    <script>
        (function () {
            const STORAGE_KEY = 'cotizador:cotizacion:v1';

            const els = {
                quoteDateText: document.getElementById('quoteDateText'),
                servicesBody: document.getElementById('servicesBody'),
                totalHours: document.getElementById('totalHours'),
                tableSubtotal: document.getElementById('tableSubtotal'),
                summarySubtotal: document.getElementById('summarySubtotal'),
                ivaRow: document.getElementById('ivaRow'),
                summaryIva: document.getElementById('summaryIva'),
                summaryTotal: document.getElementById('summaryTotal'),
                applyIva: document.getElementById('applyIva'),
                resetBtn: document.getElementById('resetBtn'),
                saveStatus: document.getElementById('saveStatus'),
                addServiceForm: document.getElementById('addServiceForm'),
                newTitle: document.getElementById('newTitle'),
                newDesc: document.getElementById('newDesc'),
                newHours: document.getElementById('newHours'),
                newRate: document.getElementById('newRate'),
            };

            function pad2(n) {
                return String(n).padStart(2, '0');
            }

            function formatSpanishDate(isoDate) {
                // isoDate: YYYY-MM-DD
                const [y, m, d] = isoDate.split('-').map(Number);
                const dt = new Date(y, (m || 1) - 1, d || 1);
                const txt = dt.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                });
                // capitaliza el mes cuando aplique
                return txt.replace(/\b([a-z√°√©√≠√≥√∫√±])/i, (c) => c.toUpperCase());
            }

            function todayIso() {
                const d = new Date();
                return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
            }

            function toNumber(value) {
                const n = Number(value);
                return Number.isFinite(n) ? n : 0;
            }

            function money(amount) {
                const n = toNumber(amount);
                const rounded = Math.round(n);
                return '$' + rounded.toLocaleString('es-MX');
            }

            function uid() {
                return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
            }

            function defaultState() {
                return {
                    meta: {
                        quoteDateIso: '2025-12-09',
                        ivaRate: 0.16,
                        applyIva: true,
                    },
                    items: [
                        {
                            id: uid(),
                            title: 'An√°lisis y Dise√±o',
                            description: 'An√°lisis de requerimientos, dise√±o de base de datos, arquitectura del sistema',
                            hours: 8,
                            rate: 150,
                        },
                        {
                            id: uid(),
                            title: 'Desarrollo Backend',
                            description: 'Sistema de autenticaci√≥n, m√≥dulo de animales, datos cl√≠nicos, gesti√≥n de im√°genes',
                            hours: 50,
                            rate: 150,
                        },
                        {
                            id: uid(),
                            title: 'Desarrollo Frontend',
                            description: 'Interfaz de usuario responsiva, formularios, validaciones, dise√±o intuitivo',
                            hours: 25,
                            rate: 150,
                        },
                        {
                            id: uid(),
                            title: 'Sistema de Reportes',
                            description: 'Generaci√≥n de documentos descargables, reportes con datos y fotograf√≠as en PDF',
                            hours: 18,
                            rate: 150,
                        },
                        {
                            id: uid(),
                            title: 'Testing y QA',
                            description: 'Pruebas funcionales, correcci√≥n de errores, validaci√≥n general del sistema',
                            hours: 12,
                            rate: 150,
                        },
                    ],
                };
            }

            function loadState() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return defaultState();
                    const parsed = JSON.parse(raw);
                    if (!parsed || !Array.isArray(parsed.items) || !parsed.meta) return defaultState();
                    return parsed;
                } catch (_) {
                    return defaultState();
                }
            }

            let saveTimer = null;
            function setSaveStatus(text) {
                if (!els.saveStatus) return;
                els.saveStatus.textContent = text;
            }

            function scheduleSave() {
                setSaveStatus('Guardando‚Ä¶');
                if (saveTimer) window.clearTimeout(saveTimer);
                saveTimer = window.setTimeout(() => {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                        setSaveStatus('Guardado');
                    } catch (e) {
                        setSaveStatus('No se pudo guardar');
                    }
                }, 250);
            }

            function compute() {
                const totalHours = state.items.reduce((acc, it) => acc + toNumber(it.hours), 0);
                const subtotal = state.items.reduce((acc, it) => acc + (toNumber(it.hours) * toNumber(it.rate)), 0);
                const iva = state.meta.applyIva ? subtotal * toNumber(state.meta.ivaRate) : 0;
                const total = subtotal + iva;
                return { totalHours, subtotal, iva, total };
            }

            function render() {
                // fecha
                els.quoteDateText.textContent = formatSpanishDate(state.meta.quoteDateIso || todayIso());

                // toggle IVA
                els.applyIva.checked = !!state.meta.applyIva;

                // filas
                els.servicesBody.innerHTML = '';

                state.items.forEach((item, index) => {
                    const tr = document.createElement('tr');

                    const lineTotal = toNumber(item.hours) * toNumber(item.rate);

                    tr.innerHTML = `
                        <td class="description">
                            <div class="desc-title-row">
                                <strong>${index + 1}. <input class="table-input" data-id="${item.id}" data-field="title" type="text" value="${escapeHtml(item.title)}" /></strong>
                                <button class="delete-link no-print" type="button" data-action="delete" data-id="${item.id}">Eliminar</button>
                            </div>
                            <div>
                                <textarea class="table-input" data-id="${item.id}" data-field="description" rows="2">${escapeHtml(item.description)}</textarea>
                            </div>
                        </td>
                        <td class="quantity"><input class="table-input" data-id="${item.id}" data-field="hours" type="number" min="0" step="0.5" value="${toNumber(item.hours)}" /></td>
                        <td class="unit-price"><input class="table-input" data-id="${item.id}" data-field="rate" type="number" min="0" step="1" value="${toNumber(item.rate)}" /></td>
                        <td class="total">${money(lineTotal)}</td>
                    `;

                    els.servicesBody.appendChild(tr);
                });

                // totales
                const { totalHours, subtotal, iva, total } = compute();
                els.totalHours.textContent = String(Math.round(totalHours * 10) / 10);
                els.tableSubtotal.textContent = money(subtotal);
                els.summarySubtotal.textContent = money(subtotal);

                if (state.meta.applyIva) {
                    els.ivaRow.style.display = 'flex';
                    els.summaryIva.textContent = money(iva);
                } else {
                    els.ivaRow.style.display = 'none';
                }

                els.summaryTotal.textContent = money(total);
            }

            function escapeHtml(str) {
                return String(str ?? '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function updateItem(id, field, value) {
                const idx = state.items.findIndex((x) => x.id === id);
                if (idx === -1) return;

                if (field === 'hours' || field === 'rate') {
                    state.items[idx][field] = Math.max(0, toNumber(value));
                } else {
                    state.items[idx][field] = String(value ?? '');
                }

                scheduleSave();
                render();
            }

            function deleteItem(id) {
                state.items = state.items.filter((x) => x.id !== id);
                scheduleSave();
                render();
            }

            function addItem({ title, description, hours, rate }) {
                state.items.push({
                    id: uid(),
                    title: String(title ?? '').trim(),
                    description: String(description ?? '').trim(),
                    hours: Math.max(0, toNumber(hours)),
                    rate: Math.max(0, toNumber(rate)),
                });
                scheduleSave();
                render();
            }

            // Estado global en este IIFE
            let state = loadState();
            // si abres por primera vez en 2026, por defecto usa hoy
            if (!state.meta.quoteDateIso) state.meta.quoteDateIso = todayIso();

            // Eventos
            document.addEventListener('input', (e) => {
                const t = e.target;
                if (!(t instanceof HTMLElement)) return;

                const id = t.getAttribute('data-id');
                const field = t.getAttribute('data-field');
                if (id && field) {
                    updateItem(id, field, t.value);
                }
            });

            document.addEventListener('click', (e) => {
                const t = e.target;
                if (!(t instanceof HTMLElement)) return;

                const action = t.getAttribute('data-action');
                if (action === 'delete') {
                    const id = t.getAttribute('data-id');
                    if (!id) return;
                    const ok = window.confirm('¬øEliminar este servicio?');
                    if (ok) deleteItem(id);
                }
            });

            els.applyIva.addEventListener('change', () => {
                state.meta.applyIva = els.applyIva.checked;
                scheduleSave();
                render();
            });

            els.resetBtn.addEventListener('click', () => {
                const ok = window.confirm('Esto borrar√° lo guardado en este navegador. ¬øContinuar?');
                if (!ok) return;
                try {
                    localStorage.removeItem(STORAGE_KEY);
                } catch (_) {}
                state = defaultState();
                scheduleSave();
                render();
            });

            els.addServiceForm.addEventListener('submit', (e) => {
                e.preventDefault();

                addItem({
                    title: els.newTitle.value,
                    description: els.newDesc.value,
                    hours: els.newHours.value,
                    rate: els.newRate.value,
                });

                els.newTitle.value = '';
                els.newDesc.value = '';
                els.newHours.value = '1';
                // mant√©n la tarifa como referencia
                els.newTitle.focus();
            });

            // Render inicial
            render();
            setSaveStatus('Listo');
        })();
    </script>
</body>
</html>
